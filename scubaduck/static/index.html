<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ScubaDuck</title>
  <style>
    body { margin: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
    #header { padding: 10px; font-weight: bold; border-bottom: 1px solid #ccc; }
    #content { flex: 1; display: flex; height: calc(100vh - 42px); overflow: hidden; }
    #sidebar { width: 300px; padding: 10px; border-right: 1px solid #ccc; overflow-y: auto; display: flex; flex-direction: column; }
    #view { flex: 1; padding: 10px; overflow-y: auto; }
    .field { display: flex; align-items: center; margin-bottom: 10px; }
    .field label { width: 80px; text-align: right; margin-right: 5px; }
    .help { margin-left: 4px; cursor: help; }
    #tabs { display: flex; align-items: center; margin-bottom: 10px; }
    #tabs .tab { margin-right: 5px; background: none; border: 1px solid #ccc; padding: 4px 8px; cursor: pointer; }
    #tabs .tab.active { background: #eee; font-weight: bold; }
    #dive { margin-left: auto; background: green; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #filter_list { display: flex; flex-direction: column; }
    th { text-align: left; cursor: pointer; }
    th.sorted { color: blue; }
  </style>
</head>
<body>
  <div id="header">sample.csv - events</div>
  <div id="content">
    <div id="sidebar">
      <div id="tabs">
        <button class="tab active" data-tab="settings">View Settings</button>
        <button class="tab" data-tab="columns">Columns</button>
        <button id="dive" onclick="dive()">Dive</button>
      </div>
      <div id="settings" class="tab-content active">
        <div class="field">
          <label>Start<span class="help" title="Sets the start/end of the time range to query. Can be any kind of datetime string. For example: 'April 23, 2014' or 'yesterday'.">[?]</span></label>
          <input id="start" type="text" />
        </div>
        <div class="field">
          <label>End<span class="help" title="Sets the start/end of the time range to query. Can be any kind of datetime string. For example: 'April 23, 2014' or 'yesterday'.">[?]</span></label>
          <input id="end" type="text" />
        </div>
        <div class="field">
          <label>Order By<span class="help" title="Choose a column to sort results by.">[?]</span></label>
          <select id="order_by"></select>
          <select id="order_dir">
            <option value="ASC">ASC</option>
            <option value="DESC">DESC</option>
          </select>
        </div>
        <div class="field">
          <label>Limit<span class="help" title="Choose the maximum number of results to show in the chart after any aggregations have been applied. For example, a limit of 10 will show no more than 10 rows for a table, etc.">[?]</span></label>
          <input id="limit" type="number" value="100" />
        </div>
        <div id="filters" class="field">
          <label>Filters<span class="help" title="You can create as many filters as you want. You can either write a filter using a UI or manual SQL. In the UI, filter consists of a column name, a relation (e.g., =, !=, <, >) and then a text field. The text field is a token input. It accepts multiple tokens for = relation, in which case we match using an OR for all options.">[?]</span></label>
          <div id="filter_list">
            <button type="button" onclick="addFilter()">Add Filter</button>
          </div>
        </div>
        <div id="query_info" style="margin-top:10px;"></div>
      </div>
      <div id="columns" class="tab-content">
        <ul id="column_list"></ul>
      </div>
    </div>
    <div id="view">
      <table id="results"></table>
    </div>
  </div>
<script>
const columns = [];
fetch('/api/columns').then(r => r.json()).then(cols => {
  const orderSelect = document.getElementById('order_by');
  cols.forEach(c => {
    const o = document.createElement('option');
    o.value = c.name;
    o.textContent = c.name;
    orderSelect.appendChild(o);
    columns.push(c.name);
  });
  const list = document.getElementById('column_list');
  cols.forEach(c => {
    const li = document.createElement('li');
    li.textContent = c.name;
    list.appendChild(li);
  });
});

document.querySelectorAll('#tabs .tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#tabs .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

function addFilter() {
  const container = document.createElement('div');
  container.className = 'filter';
  container.innerHTML = `
    <select class="f-col"></select>
    <select class="f-op">
      <option value="=">=</option>
      <option value="!=">!=</option>
      <option value="<"><</option>
      <option value=">">></option>
    </select>
    <input class="f-val" type="text">
    <button type="button" onclick="this.parentElement.remove()">X</button>
  `;
  container.querySelector('.f-col').innerHTML = columns.map(c => `<option value="${c}">${c}</option>`).join('');
  document.getElementById('filter_list').appendChild(container);
}

let lastQueryTime = 0;
let queryStart = 0;

function dive() {
  const payload = {
    start: document.getElementById('start').value,
    end: document.getElementById('end').value,
    order_by: document.getElementById('order_by').value,
    order_dir: document.getElementById('order_dir').value,
    limit: parseInt(document.getElementById('limit').value, 10),
    columns
  };
  payload.filters = Array.from(document.querySelectorAll('#filters .filter')).map(f => {
    const raw = f.querySelector('.f-val').value.trim();
    if (raw === '') {
      return {column: f.querySelector('.f-col').value, op: f.querySelector('.f-op').value, value: null};
    }
    const parts = raw.split(/\s+/);
    const value = parts.length > 1 ? parts : parts[0];
    return {column: f.querySelector('.f-col').value, op: f.querySelector('.f-op').value, value};
  });
  const view = document.getElementById('view');
  view.innerHTML = '<p>Loading...</p>';
  queryStart = performance.now();
  fetch('/api/query', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
    .then(r=>r.json())
    .then(data => {
      lastQueryTime = Math.round(performance.now() - queryStart);
      showResults(data);
    });
}

let originalRows = [];
let sortState = {index: null, dir: null};

function renderTable(rows) {
  const table = document.getElementById('results');
  table.innerHTML = '';
  if (rows.length === 0) return;
  const header = document.createElement('tr');
  columns.forEach((col, i) => {
    const th = document.createElement('th');
    th.textContent = col;
    th.dataset.index = i;
    th.addEventListener('click', handleSort);
    if (sortState.index === i) {
      th.classList.add('sorted');
      th.textContent = col + (sortState.dir === 'desc' ? ' \u25BC' : ' \u25B2');
    }
    header.appendChild(th);
  });
  table.appendChild(header);
  rows.forEach(row => {
    const tr = document.createElement('tr');
    row.forEach(v => {
      const td = document.createElement('td'); td.textContent = v; tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

function handleSort(e) {
  const idx = parseInt(e.target.dataset.index, 10);
  if (sortState.index !== idx) {
    sortState.index = idx;
    sortState.dir = 'desc';
  } else if (sortState.dir === 'desc') {
    sortState.dir = 'asc';
  } else if (sortState.dir === 'asc') {
    sortState.index = null;
    sortState.dir = null;
  } else {
    sortState.dir = 'desc';
  }
  let rows = originalRows.slice();
  if (sortState.index !== null) {
    rows.sort((a, b) => {
      const va = a[sortState.index];
      const vb = b[sortState.index];
      if (va === vb) return 0;
      if (sortState.dir === 'desc') return va < vb ? 1 : -1;
      return va > vb ? 1 : -1;
    });
  }
  renderTable(rows);
}

function showResults(data) {
  window.lastResults = data;
  const view = document.getElementById('view');
  view.innerHTML = '<table id="results"></table>';
  originalRows = data.rows.slice();
  sortState = {index: null, dir: null};
  renderTable(originalRows);
  document.getElementById('query_info').textContent =
    `Your query took about ${lastQueryTime} ms`;
}
</script>
</body>
</html>
