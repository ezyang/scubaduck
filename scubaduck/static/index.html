<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ScubaDuck</title>
  <style>
    body { margin: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
    #header { padding: 10px; font-weight: bold; border-bottom: 1px solid #ccc; }
    #content { flex: 1; display: flex; height: calc(100vh - 42px); overflow: hidden; }
    #sidebar { width: 450px; padding: 10px; border-right: 3px solid #ccc; overflow-y: auto; display: flex; flex-direction: column; box-sizing: border-box; }
    #sidebar-resizer { width: 5px; cursor: col-resize; background: #ccc; }
    #view { flex: 1; padding: 10px; overflow-y: auto; overflow-x: auto; }
    .field { display: flex; align-items: center; margin-bottom: 10px; }
    .field label { width: 80px; text-align: right; margin-right: 5px; }
    .help { margin-left: 4px; cursor: help; }
    .rel-btn { margin-left: 4px; }
    #tabs { display: flex; align-items: center; margin-bottom: 10px; }
    #tabs .tab { margin-right: 5px; background: none; border: 1px solid #ccc; padding: 4px 8px; cursor: pointer; width: 120px; text-align: center; box-sizing: border-box; }
    #tabs .tab.active { background: #eee; font-weight: bold; }
    #dive { margin-left: auto; background: green; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #filter_list { display: flex; flex-direction: column; }
    #filters .filter {
      border: 1px solid #ccc;
      padding: 5px;
      margin-bottom: 5px;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    #derived_columns .derived {
      border: 1px solid #ccc;
      padding: 5px;
      margin-bottom: 5px;
      display: flex;
      flex-direction: column;
    }
    #derived_columns .derived-row {
      display: flex;
      margin-bottom: 5px;
    }
    #derived_columns .derived-row input[type="text"] {
      margin-left: 5px;
      flex: 1;
    }
    #derived_columns .derived-row button.remove {
      margin-left: 5px;
      width: 20px;
      flex: 0 0 auto;
      padding: 0;
      text-align: center;
      line-height: 1;
    }
    #derived_columns textarea {
      width: 100%;
      box-sizing: border-box;
    }
    #filters .filter-row { display: flex; margin-bottom: 5px; }
    #filters .filter-row .f-col { flex: 1; }
    #filters .filter-row .f-op {
      margin-left: 5px;
      width: fit-content;
      flex: 0 0 auto;
    }
    .chip-input input {
      border: none;
      flex: 1;
      min-width: 60px;
      margin: 2px;
      outline: none;
    }
    .chip-box { position: relative; }
    .chip-input { display: flex; flex-wrap: wrap; border: 1px solid #ccc; padding: 2px; min-height: 24px; }
    .chip { background: #eee; border: 1px solid #999; padding: 2px 4px; margin: 2px; border-radius: 3px; display: flex; align-items: center; }
    .chip .x { margin-left: 4px; cursor: pointer; }
    .chip-copy { margin-left: 4px; cursor: pointer; background: none; border: none; }
    .chip-dropdown { position: absolute; left: 0; right: 0; top: 100%; background: white; border: 1px solid #ccc; max-height: 120px; overflow-y: auto; z-index: 10; display: none; }
    .chip-dropdown div { padding: 2px 4px; cursor: pointer; }
    .chip-dropdown div.highlight { background: #bde4ff; }
    .rel-box { position: relative; display: flex; }
    .rel-dropdown { position: absolute; left: 0; right: 0; top: 100%; background: white; border: 1px solid #ccc; z-index: 10; display: none; }
    .rel-dropdown div { padding: 2px 4px; cursor: pointer; }
    .rel-dropdown div:hover { background: #bde4ff; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-display {
      border: 1px solid #ccc;
      padding: 2px 18px 2px 4px;
      cursor: pointer;
      min-width: 80px;
      position: relative;
    }
    .dropdown-display::after {
      content: '\25BC';
      position: absolute;
      right: 4px;
      pointer-events: none;
    }
    .dropdown-menu { position: absolute; left: 0; right: 0; top: 100%; background: white; border: 1px solid #ccc; z-index: 10; max-height: 160px; overflow-y: auto; display: none; }
    .dropdown-menu input { width: 100%; box-sizing: border-box; padding: 2px 4px; border: none; border-bottom: 1px solid #ccc; }
    .dropdown-menu div { padding: 2px 4px; cursor: pointer; }
    .dropdown-menu div.selected { background: #bde4ff; }
    .dropdown-menu .option:hover { background: #eee; }
    .dropdown-menu input::placeholder { color: #999; }
    #filters .filter button.remove {
      margin-left: 5px;
      width: 20px;
      flex: 0 0 auto;
      padding: 0;
      text-align: center;
      line-height: 1;
    }
    #filters h4 { margin: 0 0 5px 0; }
    table { border-collapse: collapse; min-width: 100%; }
    th, td { border: 1px solid #ccc; padding: 4px; box-sizing: border-box; }
    td.numeric { white-space: nowrap; }
    td.date { white-space: nowrap; }
    th { text-align: left; cursor: pointer; position: relative; }
    th.sorted { color: blue; }
    tr:nth-child(even) td { background: #f9f9f9; }
    tr.selected td { background: #bde4ff !important; }
    tr:hover:not(.selected) td { background: #eee; }
    #column_actions {
      text-align: right;
      margin-bottom: 5px;
    }
    #column_actions a {
      margin-left: 5px;
    }
    .col-group-header {
      overflow: hidden;
    }
    .col-group-header .links {
      float: right;
    }
    .col-group-header .links a {
      margin-left: 5px;
    }
    #ts-container {
      display: flex;
    }
    #legend {
      width: 150px;
      flex: 0 0 150px;
      margin-right: 10px;
      overflow-y: auto;
    }
    .legend-group {
      margin-bottom: 4px;
    }
    .legend-header {
      font-weight: normal;
    }
    .legend-item {
      display: flex;
      justify-content: space-between;
      padding-left: 8px;
    }
    .legend-value {
      margin-left: 4px;
    }
    #chart-wrapper {
      flex: 1;
    }
    .legend-item.highlight {
      background: #ddd;
    }
    #legend .drill-links h4 {
      margin: 10px 0 4px 0;
    }
    #legend .drill-links a {
      display: block;
      margin-left: 8px;
    }
    #chart text.tick-label {
      font-size: 10px;
      user-select: none;
    }
    #chart text.tick-label.rotated {
      text-anchor: end;
    }
    #chart text.y-tick-label {
      font-size: 10px;
      user-select: none;
    }
    #chart line.grid {
      stroke: #ccc;
    }
    /* Column resizer removed */
  </style>
</head>
<body>
  <div id="header">sample.csv - <select id="table"></select> <select id="graph_type"><option value="samples">Samples</option><option value="table">Table</option><option value="timeseries">Time Series</option></select></div>
  <div id="content">
    <div id="sidebar">
      <div id="tabs">
        <button class="tab active" data-tab="settings">View Settings</button>
        <button id="columns_tab" class="tab" data-tab="columns">Columns</button>
        <button id="dive" onclick="dive()">Dive</button>
      </div>
      <div id="settings" class="tab-content active">
        <div class="field">
          <label>Time Column</label>
          <select id="time_column"></select>
          <select id="time_unit" style="margin-left:4px">
            <option value="s">s</option>
            <option value="ms">ms</option>
            <option value="us">us</option>
            <option value="ns">ns</option>
          </select>
        </div>
        <div class="field">
          <label>Start<span class="help" title="Sets the start/end of the time range to query. Can be any kind of datetime string. For example: 'April 23, 2014' or 'yesterday'.">[?]</span></label>
          <div class="rel-box">
            <input id="start" type="text" />
            <button type="button" class="rel-btn" data-target="start-select">&#9660;</button>
            <div id="start-select" class="rel-dropdown" data-input="start">
              <div data-value="-1 hour">-1 hour</div>
              <div data-value="-3 hours">-3 hours</div>
              <div data-value="-12 hours">-12 hours</div>
              <div data-value="-1 day">-1 day</div>
              <div data-value="-3 days">-3 days</div>
              <div data-value="-1 week">-1 week</div>
              <div data-value="-1 fortnight">-1 fortnight</div>
              <div data-value="-30 days">-30 days</div>
              <div data-value="-90 days">-90 days</div>
            </div>
          </div>
        </div>
        <div class="field">
          <label>End<span class="help" title="Sets the start/end of the time range to query. Can be any kind of datetime string. For example: 'April 23, 2014' or 'yesterday'.">[?]</span></label>
          <div class="rel-box">
            <input id="end" type="text" />
            <button type="button" class="rel-btn" data-target="end-select">&#9660;</button>
            <div id="end-select" class="rel-dropdown" data-input="end">
              <div data-value="now">now</div>
              <div data-value="-1 hour">-1 hour</div>
              <div data-value="-3 hours">-3 hours</div>
              <div data-value="-12 hours">-12 hours</div>
              <div data-value="-1 day">-1 day</div>
              <div data-value="-3 days">-3 days</div>
              <div data-value="-1 week">-1 week</div>
              <div data-value="-1 fortnight">-1 fortnight</div>
              <div data-value="-30 days">-30 days</div>
              <div data-value="-90 days">-90 days</div>
            </div>
          </div>
        </div>
        <div class="field">
          <label>Order By<span class="help" title="Choose a column to sort results by.">[?]</span></label>
          <select id="order_by"></select>
          <button id="order_dir" type="button">ASC \u25B2</button>
        </div>
        <div class="field">
          <label>Limit<span class="help" title="Choose the maximum number of results to show in the chart after any aggregations have been applied. For example, a limit of 10 will show no more than 10 rows for a table, etc.">[?]</span></label>
          <input id="limit" type="number" value="100" />
        </div>
        <div id="x_axis_field" class="field" style="display:none;">
          <label>X-axis</label>
          <select id="x_axis"></select>
        </div>
        <div id="granularity_field" class="field" style="display:none;">
          <label>Granularity</label>
          <select id="granularity">
            <option>Auto</option>
            <option>Fine</option>
            <option>1 second</option>
            <option>5 seconds</option>
            <option>10 seconds</option>
            <option>30 seconds</option>
            <option>1 minute</option>
            <option>4 minutes</option>
            <option>5 minutes</option>
            <option>10 minutes</option>
            <option>15 minutes</option>
            <option>30 minutes</option>
            <option>1 hour</option>
            <option>3 hours</option>
            <option>6 hours</option>
            <option>1 day</option>
            <option>1 week</option>
            <option>30 days</option>
          </select>
        </div>
        <div id="fill_field" class="field" style="display:none;">
          <label>Fill Missing Buckets</label>
          <select id="fill">
            <option value="0">Fill with 0 (Per Series)</option>
            <option value="connect">Connect (Per Series)</option>
            <option value="blank">Leave blank</option>
          </select>
        </div>
        <div id="group_by_field" class="field" style="display:none;">
          <label>Group By</label>
          <div class="chip-box">
          <div class="chip-input">
              <input id="group_by" class="f-val" type="text">
              <button type="button" class="chip-copy">&#x2398;</button>
          </div>
            <div class="chip-dropdown"></div>
          </div>
        </div>
        <div id="aggregate_field" class="field" style="display:none;">
          <label>Aggregate</label>
          <select id="aggregate">
            <option>Avg</option>
            <option>Count</option>
            <option>Sum</option>
            <option>Min</option>
            <option>Max</option>
            <option>Count Distinct</option>
            <option>p5</option>
            <option>p25</option>
            <option>p50</option>
            <option>p70</option>
            <option>p75</option>
            <option>p90</option>
            <option>p95</option>
            <option>p99</option>
            <option>p99.9</option>
            <option>p99.99</option>
          </select>
        </div>
        <div id="show_hits_field" class="field" style="display:none;">
          <label>Show Hits</label>
          <input id="show_hits" type="checkbox" checked>
        </div>
        <div id="filters">
          <h4>Filters<span class="help" title="You can create as many filters as you want. You can either write a filter using a UI or manual SQL. In the UI, filter consists of a column name, a relation (e.g., =, !=, <, >) and then a text field. The text field is a token input. It accepts multiple tokens for = relation, in which case we match using an OR for all options.">[?]</span></h4>
          <div id="filter_list"></div>
          <button id="add_filter" type="button" onclick="addFilter()">Add Filter</button>
        </div>
        <div id="query_info" style="margin-top:10px;"></div>
      </div>
      <div id="columns" class="tab-content">
        <div id="column_actions">
          <a id="columns_all" href="#">All</a>
          <a id="columns_none" href="#">None</a>
        </div>
        <div id="column_groups"></div>
        <div id="derived_columns">
          <h4>Derived Columns</h4>
          <div id="derived_list"></div>
          <button id="add_derived" type="button" onclick="addDerived()">Add Derived</button>
        </div>
      </div>
  </div>
  <div id="sidebar-resizer"></div>
  <div id="view">
    <table id="results"></table>
  </div>
</div>
<script src="/js/chip_input.js"></script>
<script src="/js/timeseries_chart.js"></script>
<script>
const allColumns = [];
const baseColumns = [];
const columnTypes = {};
const stringColumns = [];
const baseStringColumns = [];
const integerColumns = [];
const baseIntegerColumns = [];
const timeColumns = [];
const baseTimeColumns = [];
const timeColumnOptions = [];
const baseTimeColumnOptions = [];
const derivedColumns = [];
let selectedColumns = [];
let displayType = 'samples';
let groupBy = {chips: [], addChip: () => {}, renderChips: () => {}};
let defaultTimeColumn = '';
const limitInput = document.getElementById('limit');
const limitValues = {
  samples: parseInt(limitInput.value, 10),
  table: parseInt(limitInput.value, 10),
  timeseries: 7
};
const columnValues = {
  samples: [],
  table: [],
  timeseries: []
};
limitInput.addEventListener('input', () => {
  limitValues[displayType] = parseInt(limitInput.value, 10);
  limitInput.dataset.setByUser = '1';
});

function initDropdown(select) {
  const wrapper = document.createElement('div');
  wrapper.className = 'dropdown';
  if (select.classList.contains('f-col')) {
    wrapper.classList.add('f-col');
  }
  select.parentNode.insertBefore(wrapper, select);
  wrapper.appendChild(select);
  select.style.display = 'none';
  const disp = document.createElement('div');
  disp.className = 'dropdown-display';
  function updateDisplay() {
    const opt = select.options[select.selectedIndex];
    disp.textContent = opt ? opt.textContent : '';
  }
  updateDisplay();
  wrapper.appendChild(disp);
  const menu = document.createElement('div');
  menu.className = 'dropdown-menu';
  const search = document.createElement('input');
  search.placeholder = 'Search';
  menu.appendChild(search);
  const list = document.createElement('div');
  menu.appendChild(list);
  wrapper.appendChild(menu);

  function close() {
    menu.style.display = 'none';
  }

  function open() {
    renderOptions();
    menu.style.display = 'block';
    search.focus();
  }

  disp.addEventListener('click', () => {
    if (menu.style.display === 'block') {
      close();
    } else {
      open();
    }
  });

  document.addEventListener('click', e => {
    if (!wrapper.contains(e.target)) {
      close();
    }
  });

  function renderOptions() {
    const q = search.value.toLowerCase();
    list.innerHTML = '';
    Array.from(select.options).forEach(o => {
      if (!o.textContent.toLowerCase().includes(q)) return;
      const div = document.createElement('div');
      div.className = 'option';
      if (q) {
        const text = o.textContent;
        const idx = text.toLowerCase().indexOf(q);
        if (idx !== -1) {
          div.innerHTML =
            text.slice(0, idx) +
            '<u>' +
            text.slice(idx, idx + q.length) +
            '</u>' +
            text.slice(idx + q.length);
        } else {
          div.textContent = text;
        }
      } else {
        div.textContent = o.textContent;
      }
      if (o.value === select.value) div.classList.add('selected');
      div.addEventListener('mousedown', evt => {
        evt.preventDefault();
        select.value = o.value;
        select.dispatchEvent(new Event('change'));
        updateDisplay();
        close();
      });
      list.appendChild(div);
    });
  }

  search.addEventListener('input', renderOptions);
  select.addEventListener('change', updateDisplay);
}
// Sidebar resizing
const sidebar = document.getElementById('sidebar');
const sidebarResizer = document.getElementById('sidebar-resizer');
let sidebarWidth = parseInt(localStorage.getItem('sidebarWidth') || 450, 10);
sidebar.style.width = sidebarWidth + 'px';
let sidebarResize = false;
function startSidebarDrag(e) {
  e.preventDefault();
  sidebarResize = true;
  document.addEventListener('mousemove', onSidebarDrag);
  document.addEventListener('mouseup', stopSidebarDrag);
}
function onSidebarDrag(e) {
  if (!sidebarResize) return;
  sidebarWidth = Math.max(200, e.clientX - sidebar.getBoundingClientRect().left);
  sidebar.style.width = sidebarWidth + 'px';
}
function stopSidebarDrag() {
  document.removeEventListener('mousemove', onSidebarDrag);
  document.removeEventListener('mouseup', stopSidebarDrag);
  sidebarResize = false;
  localStorage.setItem('sidebarWidth', sidebarWidth);
}
sidebarResizer.addEventListener('mousedown', startSidebarDrag);
let orderDir = 'ASC';
const orderDirBtn = document.getElementById('order_dir');
const graphTypeSel = document.getElementById('graph_type');
function updateOrderDirButton() {
  orderDirBtn.textContent = orderDir + (orderDir === 'ASC' ? ' \u25B2' : ' \u25BC');
}

function updateDisplayTypeUI() {
  const prevType = displayType;
  updateSelectedColumns(prevType);
  const newType = graphTypeSel.value;
  const showTable = newType === 'table';
  const showTS = newType === 'timeseries';
  document.getElementById('group_by_field').style.display = showTable || showTS ? 'flex' : 'none';
  document.getElementById('aggregate_field').style.display = showTable || showTS ? 'flex' : 'none';
  document.getElementById('show_hits_field').style.display = showTable ? 'flex' : 'none';
  document.getElementById('x_axis_field').style.display = showTS ? 'flex' : 'none';
  document.getElementById('granularity_field').style.display = showTS ? 'flex' : 'none';
  document.getElementById('fill_field').style.display = showTS ? 'flex' : 'none';
  document.querySelectorAll('#column_groups .col-group').forEach(g => {
    if (g.querySelector('.col-group-header').textContent.startsWith('Strings')) {
      g.style.display = showTable || showTS ? 'none' : '';
    }
  });
  limitValues[prevType] = parseInt(limitInput.value, 10);
  if (showTS && limitValues.timeseries === undefined) {
    limitValues.timeseries = 7;
  }
  limitInput.value = limitValues[newType];
  document.querySelectorAll('#column_groups input').forEach(cb => {
    cb.checked = columnValues[newType].includes(cb.value);
  });
  if (showTS) {
    document.querySelectorAll('#column_groups input').forEach(cb => {
      if (isTimeColumn(cb.value) || isStringColumn(cb.value)) {
        cb.checked = false;
      }
    });
    document.getElementById('order_by').value = '';
  }
  updateSelectedColumns(newType);
  displayType = newType;
}
function updateTimeFieldVisibility() {
  const show = document.getElementById('time_column').value !== '';
  document.getElementById('start').closest('.field').style.display = show
    ? 'flex'
    : 'none';
  document.getElementById('end').closest('.field').style.display = show
    ? 'flex'
    : 'none';
}
orderDirBtn.addEventListener('click', () => {
  orderDir = orderDir === 'ASC' ? 'DESC' : 'ASC';
  updateOrderDirButton();
});
updateOrderDirButton();
graphTypeSel.addEventListener('change', updateDisplayTypeUI);
document.getElementById('time_column').addEventListener('change', updateTimeFieldVisibility);
updateTimeFieldVisibility();

function loadColumns(table) {
  return fetch('/api/columns?table=' + encodeURIComponent(table)).then(r => r.json()).then(cols => {
    const orderSelect = document.getElementById('order_by');
    const xAxisSelect = document.getElementById('x_axis');
    const groupsEl = document.getElementById('column_groups');
    const timeColumnSelect = document.getElementById('time_column');
    orderSelect.innerHTML = '';
    xAxisSelect.innerHTML = '';
    const defOpt = document.createElement('option');
    defOpt.value = '';
    defOpt.textContent = '(default)';
    xAxisSelect.appendChild(defOpt);
    timeColumnSelect.innerHTML = '';
    const noneOpt = document.createElement('option');
    noneOpt.value = '';
    noneOpt.textContent = '(none)';
    timeColumnSelect.appendChild(noneOpt);
    groupsEl.innerHTML = '';
    allColumns.length = 0;
    stringColumns.length = 0;
    integerColumns.length = 0;
    timeColumns.length = 0;
    timeColumnOptions.length = 0;
    baseColumns.length = 0;
    baseStringColumns.length = 0;
    baseIntegerColumns.length = 0;
    baseTimeColumns.length = 0;
    baseTimeColumnOptions.length = 0;
    for (const k in columnTypes) delete columnTypes[k];
    const groups = {
      time: {name: 'Time', cols: [], ul: null},
      integer: {name: 'Integers', cols: [], ul: null},
      string: {name: 'Strings', cols: [], ul: null},
    };
    const heur = ['timestamp','created','created_at','event_time','time','date','occurred','happened','logged'];
    let guess = null;
    cols.forEach(c => {
      const t = c.type.toUpperCase();
      columnTypes[c.name] = c.type;
      allColumns.push(c.name);
      baseColumns.push(c.name);
      let g = 'string';
      const isNumeric = t.includes('INT') || t.includes('DECIMAL') || t.includes('NUMERIC') || t.includes('REAL') || t.includes('DOUBLE') || t.includes('FLOAT') || t.includes('HUGEINT');
      const isTimeType = t.includes('TIMESTAMP') || t.includes('DATE') || t.includes('TIME');
      if (isNumeric || isTimeType) {
        timeColumnOptions.push(c.name);
        baseTimeColumnOptions.push(c.name);
        if (!guess && heur.some(h => c.name.toLowerCase().includes(h))) guess = c.name;
      }
      if (isTimeType) {
        g = 'time';
        timeColumns.push(c.name);
        baseTimeColumns.push(c.name);
      } else if (isNumeric) {
        g = 'integer';
      }
      if (g === 'string') {
        stringColumns.push(c.name);
        baseStringColumns.push(c.name);
      } else if (g === 'integer') {
        integerColumns.push(c.name);
        baseIntegerColumns.push(c.name);
      }
      groups[g].cols.push(c.name);
      if (g !== 'string') {
        const o = document.createElement('option');
        o.value = c.name;
        o.textContent = c.name;
        orderSelect.appendChild(o);
      }
    });
    timeColumns.forEach(name => {
      const o = document.createElement('option');
      o.value = name;
      o.textContent = name;
      xAxisSelect.appendChild(o);
    });
    timeColumnOptions.forEach(name => {
      const o = document.createElement('option');
      o.value = name;
      o.textContent = name;
      timeColumnSelect.appendChild(o);
    });
    xAxisSelect.value = '';
    defaultTimeColumn = guess || timeColumnOptions[0] || '';
    updateTimeFieldVisibility();
    Object.keys(groups).forEach(key => {
      const g = groups[key];
      const div = document.createElement('div');
      div.className = 'col-group';
      const header = document.createElement('div');
      header.className = 'col-group-header';
      header.appendChild(document.createTextNode(g.name + ': '));
      const links = document.createElement('span');
      links.className = 'links';
      const allBtn = document.createElement('a');
      allBtn.href = '#';
      allBtn.textContent = 'All';
      const noneBtn = document.createElement('a');
      noneBtn.href = '#';
      noneBtn.textContent = 'None';
      links.appendChild(allBtn);
      links.appendChild(noneBtn);
      header.appendChild(links);
      div.appendChild(header);
      const ul = document.createElement('ul');
      g.ul = ul;
      g.cols.forEach(name => {
        const li = document.createElement('li');
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = name;
        cb.checked = true;
        cb.addEventListener('change', updateSelectedColumns);
        label.appendChild(cb);
        label.appendChild(document.createTextNode(' ' + name));
        li.appendChild(label);
        ul.appendChild(li);
      });
      allBtn.addEventListener('click', e => {
        e.preventDefault();
        ul.querySelectorAll('input').forEach(cb => (cb.checked = true));
        updateSelectedColumns();
      });
      noneBtn.addEventListener('click', e => {
        e.preventDefault();
        ul.querySelectorAll('input').forEach(cb => (cb.checked = false));
        updateSelectedColumns();
      });
      div.appendChild(ul);
      groupsEl.appendChild(div);
    });
    document.getElementById('columns_all').addEventListener('click', e => {
      e.preventDefault();
      groupsEl.querySelectorAll('input').forEach(cb => (cb.checked = true));
      updateSelectedColumns();
    });
    document.getElementById('columns_none').addEventListener('click', e => {
      e.preventDefault();
      groupsEl.querySelectorAll('input').forEach(cb => (cb.checked = false));
      updateSelectedColumns();
    });
    updateSelectedColumns();
    columnValues.samples = allColumns.slice();
    columnValues.table = [];
    columnValues.timeseries = [];
    groupBy = document.getElementById('group_by').closest('.field');
    initChipInput(groupBy, typed =>
      allColumns.filter(c => c.toLowerCase().includes(typed.toLowerCase()))
    );
    initDropdown(orderSelect);
    initDropdown(document.getElementById('aggregate'));
  });
}

let columnsInitialized = false;
fetch('/api/tables').then(r => r.json()).then(tables => {
  tables.forEach(t => {
    const o = document.createElement('option');
    o.value = t;
    o.textContent = t;
    document.getElementById('table').appendChild(o);
  });
  const table = parseSearch().table || tables[0];
  document.getElementById('table').value = table;
  loadColumns(table).then(() => {
    updateDisplayTypeUI();
    addFilter();
    initFromUrl();
    columnsInitialized = true;
  });
  document.getElementById('table').addEventListener('change', () => {
    loadColumns(document.getElementById('table').value).then(() => {
      if (columnsInitialized) {
        applyParams(parseSearch());
      }
    });
  });
});

document.querySelectorAll('#tabs .tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#tabs .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

document.querySelectorAll('.rel-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const dd = document.getElementById(btn.dataset.target);
    const show = dd.style.display === 'none' || dd.style.display === '';
    document.querySelectorAll('.rel-dropdown').forEach(d => (d.style.display = 'none'));
    dd.style.display = show ? 'block' : 'none';
  });
});
document.querySelectorAll('.rel-dropdown div').forEach(opt => {
  opt.addEventListener('click', () => {
    const box = opt.closest('.rel-box');
    const input = box.querySelector('input');
    input.value = opt.dataset.value || opt.textContent;
    opt.parentElement.style.display = 'none';
  });
});

document.addEventListener('click', e => {
  document.querySelectorAll('.rel-dropdown').forEach(dd => {
    if (!dd.parentElement.contains(e.target)) dd.style.display = 'none';
  });
});

function updateColumnsTabCount() {
  const baseCount = document.querySelectorAll('#column_groups input:checked').length;
  const derivedCount = document.querySelectorAll('#derived_list .derived .d-use:checked').length;
  const btn = document.getElementById('columns_tab');
  if (btn) btn.textContent = `Columns (${baseCount + derivedCount})`;
}

function updateSelectedColumns(type = graphTypeSel.value) {
  const base = allColumns.filter(name => {
    const cb = document.querySelector(`#column_groups input[value="${name}"]`);
    if (!cb || !cb.checked) return false;
    if (type === 'table' && isStringColumn(name)) return false;
    return true;
  });
  if (type === 'table' || type === 'timeseries') {
    selectedColumns = groupBy.chips.slice();
    if (document.getElementById('show_hits').checked) selectedColumns.push('Hits');
    base.forEach(c => {
      if (!selectedColumns.includes(c)) selectedColumns.push(c);
    });
    derivedColumns.forEach(dc => {
      if (dc.include && !selectedColumns.includes(dc.name)) selectedColumns.push(dc.name);
    });
  } else {
    selectedColumns = base.slice();
    derivedColumns.forEach(dc => {
      if (dc.include) selectedColumns.push(dc.name);
    });
  }
  columnValues[type] = selectedColumns.slice();
  updateColumnsTabCount();
}

function isStringColumn(name) {
  const t = (columnTypes[name] || '').toUpperCase();
  return t.includes('CHAR') || t.includes('STRING') || t.includes('VARCHAR');
}

function isIntegerColumn(name) {
  const t = (columnTypes[name] || '').toUpperCase();
  return t.includes('INT');
}

function isTimeColumn(name) {
  const t = (columnTypes[name] || '').toUpperCase();
  if (t.includes('TIMESTAMP') || t.includes('DATE') || t.includes('TIME')) return true;
  const sel = document.getElementById('time_column').value;
  const xsel = document.getElementById('x_axis').value;
  if (name === sel || name === xsel) return true;
  return false;
}

function formatNumber(val) {
  if (typeof val !== 'number') val = Number(val);
  if (Number.isNaN(val)) return '';
  if (val === 0) return '0';
  const abs = Math.abs(val);
  if (abs > 999.999) {
    const units = [
      {n: 1e12, s: 'T'},
      {n: 1e9, s: 'B'},
      {n: 1e6, s: 'M'},
      {n: 1e3, s: 'K'},
    ];
    for (const u of units) {
      if (abs >= u.n) {
        return (val / u.n).toFixed(2) + ' ' + u.s;
      }
    }
  }
  if (abs < 0.0005) return '0.000';
  if (Number.isInteger(val)) return val.toString();
  return val.toFixed(3);
}


function addFilter() {
  const container = document.createElement('div');
  container.className = 'filter';
  container.innerHTML = `
    <div class="filter-row">
      <select class="f-col"></select>
      <select class="f-op"></select>
      <button type="button" class="remove" onclick="this.closest('.filter').remove()">✖</button>
    </div>
    <div class="chip-box">
      <div class="chip-input">
        <input class="f-val" type="text">
        <button type="button" class="chip-copy">&#x2398;</button>
      </div>
      <div class="chip-dropdown"></div>
    </div>
  `;
  const colSel = container.querySelector('.f-col');
  colSel.innerHTML = allColumns.map(c => `<option value="${c}">${c}</option>`).join('');
  initDropdown(colSel);

  function populateOps() {
    const opSel = container.querySelector('.f-op');
    const col = colSel.value;
    const ops = isStringColumn(col)
      ? [
          ['=', '='],
          ['!=', '!='],
          ['~', 'matches regex'],
          ['!~', 'not matches regex'],
          ['contains', 'contains'],
          ['!contains', 'not contains'],
          ['empty', 'empty'],
          ['!empty', 'not empty'],
          ['LIKE', 'like'],
        ]
      : [
          ['=', '='],
          ['!=', '!='],
          ['<', '<'],
          ['>', '>'],
        ];
    opSel.innerHTML = ops.map(o => `<option value="${o[0]}">${o[1]}</option>`).join('');
    updateInputVis();
  }

  function updateInputVis() {
    const op = container.querySelector('.f-op').value;
    const box = container.querySelector('.chip-box');
    box.style.display = op === 'empty' || op === '!empty' ? 'none' : 'block';
  }

  colSel.addEventListener('change', populateOps);
  container.querySelector('.f-op').addEventListener('change', updateInputVis);
  populateOps();
  document.getElementById('filter_list').appendChild(container);
  initChipInput(container, (typed, el) => {
    const colEl = el.querySelector('.f-col select') || el.querySelector('.f-col');
    if (!colEl) return [];
    const col = colEl.value;
    if (!isStringColumn(col)) return [];
    return fetch(`/api/samples?column=${encodeURIComponent(col)}&q=${encodeURIComponent(typed)}`)
      .then(r => r.json());
  });
}

function nextDerivedName() {
  let n = 1;
  while (true) {
    const name = `derived_${n}`;
    if (!derivedColumns.some(d => d.name === name) && !allColumns.includes(name)) return name;
    n++;
  }
}

function addDerived(data = {}) {
  const container = document.createElement('div');
  container.className = 'derived';
  container.innerHTML = `
    <div class="derived-row">
      <select class="d-type">
        <option value="aggregated">Aggregated</option>
        <option value="string">String</option>
        <option value="numeric">Numeric</option>
      </select>
      <input class="d-name" type="text">
      <button type="button" class="remove" onclick="removeDerived(this)">✖</button>
    </div>
    <label><input type="checkbox" class="d-use" checked> Include in Query</label>
    <textarea class="d-expr" rows="2"></textarea>
  `;
  document.getElementById('derived_list').appendChild(container);
  const obj = {
    type: data.type || 'string',
    name: data.name || nextDerivedName(),
    expr: data.expr || '',
    include: data.include !== undefined ? data.include : true,
    el: container
  };
  container.querySelector('.d-type').value = obj.type;
  container.querySelector('.d-name').value = obj.name;
  container.querySelector('.d-expr').value = obj.expr;
  container.querySelector('.d-use').checked = obj.include;
  ['change','input'].forEach(evt => {
    container.addEventListener(evt, refreshDerivedColumns);
  });
  derivedColumns.push(obj);
  refreshDerivedColumns();
}

function removeDerived(btn) {
  const el = btn.closest('.derived');
  const idx = derivedColumns.findIndex(d => d.el === el);
  if (idx !== -1) {
    derivedColumns.splice(idx, 1);
  }
  el.remove();
  refreshDerivedColumns();
}

function refreshDerivedColumns() {
  allColumns.splice(0, allColumns.length, ...baseColumns);
  stringColumns.splice(0, stringColumns.length, ...baseStringColumns);
  integerColumns.splice(0, integerColumns.length, ...baseIntegerColumns);
  timeColumns.splice(0, timeColumns.length, ...baseTimeColumns);
  timeColumnOptions.splice(0, timeColumnOptions.length, ...baseTimeColumnOptions);
  derivedColumns.forEach(d => {
    d.type = d.el.querySelector('.d-type').value;
    d.name = d.el.querySelector('.d-name').value;
    d.expr = d.el.querySelector('.d-expr').value;
    d.include = d.el.querySelector('.d-use').checked;
    allColumns.push(d.name);
    columnTypes[d.name] = d.type;
    if (d.type === 'string') {
      stringColumns.push(d.name);
    } else {
      integerColumns.push(d.name);
      timeColumnOptions.push(d.name);
    }
  });
  updateSelectedColumns();
}

let lastQueryTime = 0;
let queryStart = 0;

function dive(push=true) {
  const params = collectParams();
  if (push) {
    history.pushState(params, '', paramsToSearch(params));
  }
  const payload = Object.assign({}, params);
  const dcMap = {};
  (params.derived_columns || []).forEach(d => {
    if (d.include) dcMap[d.name] = d.expr;
  });
  payload.derived_columns = dcMap;
  const view = document.getElementById('view');
  view.innerHTML = '<p>Loading...</p>';
  window.lastResults = undefined;
  queryStart = performance.now();
  fetch('/api/query', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw data;
      return data;
    })
    .then(data => {
      lastQueryTime = Math.round(performance.now() - queryStart);
      showResults(data);
    })
    .catch(err => {
      showError(err);
    });
}

function collectParams() {
  updateSelectedColumns();
  const payload = {
    table: document.getElementById('table').value,
    time_column: document.getElementById('time_column').value,
    time_unit: document.getElementById('time_unit').value,
    start: document.getElementById('start').value,
    end: document.getElementById('end').value,
    order_by: document.getElementById('order_by').value,
    order_dir: orderDir,
    limit: parseInt(document.getElementById('limit').value, 10),
    columns: selectedColumns.filter(c =>
      c !== 'Hits' && !derivedColumns.some(dc => dc.name === c)
    ),
    samples_columns: columnValues.samples.slice(),
    table_columns: columnValues.table.slice(),
    timeseries_columns: columnValues.timeseries.slice(),
    graph_type: graphTypeSel.value,
    filters: Array.from(document.querySelectorAll('#filters .filter')).map(f => {
      const chips = f.chips || [];
      const op = f.querySelector('.f-op').value;
      let value = null;
      if (op !== 'empty' && op !== '!empty') {
        value = chips.length === 0 ? null : (chips.length === 1 ? chips[0] : chips);
      }
      const colSel = f.querySelector('.f-col select') || f.querySelector('.f-col');
      return {column: colSel.value, op, value};
    }),
    derived_columns: Array.from(document.querySelectorAll('#derived_list .derived')).map(d => ({
      type: d.querySelector('.d-type').value,
      name: d.querySelector('.d-name').value,
      expr: d.querySelector('.d-expr').value,
      include: d.querySelector('.d-use').checked,
    }))
  };
  if (graphTypeSel.value === 'table' || graphTypeSel.value === 'timeseries') {
    payload.group_by = groupBy.chips || [];
    payload.aggregate = document.getElementById('aggregate').value;
    payload.show_hits = document.getElementById('show_hits').checked;
  }
  if (graphTypeSel.value === 'timeseries') {
    const xval = document.getElementById('x_axis').value;
    if (xval) payload.x_axis = xval;
    payload.granularity = document.getElementById('granularity').value;
    payload.fill = document.getElementById('fill').value;
  }
  return payload;
}

function paramsToSearch(params) {
  const sp = new URLSearchParams();
  if (params.table) sp.set('table', params.table);
  if (params.time_column) sp.set('time_column', params.time_column);
  if (params.time_unit) sp.set('time_unit', params.time_unit);
  if (params.start) sp.set('start', params.start);
  if (params.end) sp.set('end', params.end);
  if (params.order_by) sp.set('order_by', params.order_by);
  if (params.order_dir) sp.set('order_dir', params.order_dir);
  if (params.limit !== null && params.limit !== undefined) sp.set('limit', params.limit);
  if (params.samples_columns && params.samples_columns.length) sp.set('samples_columns', params.samples_columns.join(','));
  if (params.table_columns && params.table_columns.length) sp.set('table_columns', params.table_columns.join(','));
  if (params.timeseries_columns && params.timeseries_columns.length) sp.set('timeseries_columns', params.timeseries_columns.join(','));
  if (params.filters && params.filters.length) sp.set('filters', JSON.stringify(params.filters));
  if (params.derived_columns && params.derived_columns.length) sp.set('derived_columns', JSON.stringify(params.derived_columns));
  if (params.graph_type) sp.set('graph_type', params.graph_type);
  if (params.graph_type === 'table' || params.graph_type === 'timeseries') {
    if (params.group_by && params.group_by.length) sp.set('group_by', params.group_by.join(','));
    if (params.aggregate) sp.set('aggregate', params.aggregate);
    if (params.show_hits) sp.set('show_hits', '1');
  }
  if (params.graph_type === 'timeseries') {
    if (params.x_axis) sp.set('x_axis', params.x_axis);
    if (params.granularity) sp.set('granularity', params.granularity);
    if (params.fill) sp.set('fill', params.fill);
  }
  const qs = sp.toString();
  return qs ? '?' + qs : '';
}

function applyParams(params) {
  if (params.table) document.getElementById('table').value = params.table;
  document.getElementById('time_column').value = params.time_column || defaultTimeColumn;
  updateTimeFieldVisibility();
  if (params.time_unit) document.getElementById('time_unit').value = params.time_unit;
  document.getElementById('start').value = params.start || '';
  document.getElementById('end').value = params.end || '';
  if (params.order_by) {
    document.getElementById('order_by').value = params.order_by;
  }
  orderDir = params.order_dir || 'ASC';
  updateOrderDirButton();
  if (params.limit !== undefined && params.limit !== null) {
    document.getElementById('limit').value = params.limit;
    limitValues[params.graph_type || 'samples'] = params.limit;
    limitInput.dataset.setByUser = '1';
  }
  graphTypeSel.value = params.graph_type || 'samples';
  updateDisplayTypeUI();
  limitInput.value = limitValues[graphTypeSel.value];
  if (params.x_axis) {
    document.getElementById('x_axis').value = params.x_axis;
  } else {
    document.getElementById('x_axis').value = '';
  }
  if (params.granularity) document.getElementById('granularity').value = params.granularity;
  if (params.fill) document.getElementById('fill').value = params.fill;
  if (params.group_by) {
    groupBy.chips.splice(0, groupBy.chips.length, ...params.group_by);
    groupBy.renderChips();
  }
  if (params.aggregate) document.getElementById('aggregate').value = params.aggregate;
  document.getElementById('show_hits').checked = params.show_hits ?? true;
  if (params.samples_columns) columnValues.samples = params.samples_columns;
  if (params.table_columns) columnValues.table = params.table_columns;
  if (params.timeseries_columns) columnValues.timeseries = params.timeseries_columns;
  document.querySelectorAll('#column_groups input').forEach(cb => {
    cb.checked = columnValues[graphTypeSel.value].includes(cb.value);
  });
  updateSelectedColumns(graphTypeSel.value);
  const dlist = document.getElementById('derived_list');
  dlist.innerHTML = '';
  derivedColumns.splice(0, derivedColumns.length);
  if (params.derived_columns && params.derived_columns.length) {
    params.derived_columns.forEach(dc => addDerived(dc));
  }
  refreshDerivedColumns();
  const list = document.getElementById('filter_list');
  list.innerHTML = '';
  if (params.filters && params.filters.length) {
    params.filters.forEach(f => {
      addFilter();
      const el = list.lastElementChild;
      const colSel = el.querySelector('.f-col select') || el.querySelector('.f-col');
      colSel.value = f.column;
      colSel.dispatchEvent(new Event('change'));
      el.querySelector('.f-op').value = f.op;
      el.querySelector('.f-op').dispatchEvent(new Event('change'));
      if (f.value !== null && f.op !== 'empty' && f.op !== '!empty') {
        const values = Array.isArray(f.value) ? f.value : [f.value];
        values.forEach(v => el.addChip(v));
        el.renderChips();
      }
    });
  } else {
    addFilter();
  }
}

function parseSearch() {
  const sp = new URLSearchParams(window.location.search);
  const params = {};
  if (sp.has('table')) params.table = sp.get('table');
  if (sp.has('time_column')) params.time_column = sp.get('time_column');
  if (sp.has('time_unit')) params.time_unit = sp.get('time_unit');
  if (sp.has('start')) params.start = sp.get('start');
  if (sp.has('end')) params.end = sp.get('end');
  if (sp.has('order_by')) params.order_by = sp.get('order_by');
  if (sp.has('order_dir')) params.order_dir = sp.get('order_dir');
  if (sp.has('limit')) params.limit = parseInt(sp.get('limit'), 10);
  if (sp.has('samples_columns')) params.samples_columns = sp.get('samples_columns').split(',').filter(c => c);
  if (sp.has('table_columns')) params.table_columns = sp.get('table_columns').split(',').filter(c => c);
  if (sp.has('timeseries_columns')) params.timeseries_columns = sp.get('timeseries_columns').split(',').filter(c => c);
  if (sp.has('filters')) {
    try { params.filters = JSON.parse(sp.get('filters')); } catch(e) { params.filters = []; }
  }
  if (sp.has('graph_type')) params.graph_type = sp.get('graph_type');
  if (sp.has('group_by')) params.group_by = sp.get('group_by').split(',').filter(c => c);
  if (sp.has('aggregate')) params.aggregate = sp.get('aggregate');
  if (sp.has('show_hits')) params.show_hits = sp.get('show_hits') === '1';
  if (sp.has('x_axis')) params.x_axis = sp.get('x_axis');
  if (sp.has('granularity')) params.granularity = sp.get('granularity');
  if (sp.has('fill')) params.fill = sp.get('fill');
  if (sp.has('derived_columns')) {
    try { params.derived_columns = JSON.parse(sp.get('derived_columns')); } catch(e) { params.derived_columns = []; }
  }
  return params;
}

function initFromUrl() {
  const params = parseSearch();
  history.replaceState(params, '', paramsToSearch(params));
  applyParams(params);
  dive(false);
}

window.addEventListener('popstate', e => {
  const params = e.state || parseSearch();
  applyParams(params);
  dive(false);
});

let originalRows = [];
let sortState = {index: null, dir: null};

function renderTable(rows) {
  const table = document.getElementById('results');
  table.innerHTML = '';
  if (rows.length === 0) return;
  let hitsIndex = selectedColumns.indexOf('Hits');
  let totalHits = 0;
  if (hitsIndex !== -1) {
    totalHits = rows.reduce((s, r) => s + Number(r[hitsIndex]), 0);
  }
  const header = document.createElement('tr');
  selectedColumns.forEach((col, i) => {
    const th = document.createElement('th');
    let label = col;
    if (
      displayType === 'table' &&
      col !== 'Hits' &&
      !(groupBy.chips || []).includes(col)
    ) {
      const agg = document.getElementById('aggregate').value.toLowerCase();
      label += ` (${agg})`;
    }
    th.textContent = label;
    th.dataset.index = i;
    th.addEventListener('click', handleSort);
    if (sortState.index === i) {
      th.classList.add('sorted');
      th.textContent =
        label + (sortState.dir === 'desc' ? ' \u25BC' : ' \u25B2');
    }
    if (!isStringColumn(col)) th.style.textAlign = 'right';
    header.appendChild(th);
  });
  table.appendChild(header);
  rows.forEach(row => {
    const tr = document.createElement('tr');
    tr.addEventListener('click', () => {
      const wasSelected = tr.classList.contains('selected');
      document
        .querySelectorAll('#results tr.selected')
        .forEach(el => el.classList.remove('selected'));
      if (!wasSelected) {
        tr.classList.add('selected');
      }
    });
    row.forEach((v, i) => {
      const col = selectedColumns[i];
      const td = document.createElement('td');
      if (isTimeColumn(col)) {
        let d;
        const t = (columnTypes[col] || '').toUpperCase();
        if (t.includes('TIMESTAMP') || t.includes('DATE') || t.includes('TIME')) {
          d = new Date(v);
        } else {
          const unit = document.getElementById('time_unit').value;
          const factors = {s: 1000, ms: 1, us: 0.001, ns: 0.000001};
          d = new Date(Number(v) * (factors[unit] || 1000));
        }
        td.textContent = d.toLocaleString('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
          second: 'numeric',
          hour12: true,
          timeZoneName: 'short'
        });
        td.classList.add('date');
      } else {
        if (col === 'Hits') {
          const pct = totalHits ? ((v / totalHits) * 100).toFixed(1) : '0';
          td.textContent = `${formatNumber(v)} (${pct}%)`;
        } else {
          td.textContent = isStringColumn(col) ? v : formatNumber(v);
        }
      }
      if (!isStringColumn(col) && !isTimeColumn(col)) {
        td.classList.add('numeric');
      }
      td.style.textAlign = isStringColumn(col) ? 'left' : 'right';
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
  // ensure table does not overflow unless necessary
  const view = document.getElementById('view');
  if (table.scrollWidth <= view.clientWidth) {
    table.style.width = '100%';
  }
}

function handleSort(e) {
  const idx = parseInt(e.target.dataset.index, 10);
  if (sortState.index !== idx) {
    sortState.index = idx;
    sortState.dir = 'asc';
  } else if (sortState.dir === 'asc') {
    sortState.dir = 'desc';
  } else if (sortState.dir === 'desc') {
    sortState.index = null;
    sortState.dir = null;
  } else {
    sortState.dir = 'asc';
  }
  let rows = originalRows.slice();
  if (sortState.index !== null) {
    rows.sort((a, b) => {
      const va = a[sortState.index];
      const vb = b[sortState.index];
      if (va === vb) return 0;
      if (sortState.dir === 'desc') return va < vb ? 1 : -1;
      return va > vb ? 1 : -1;
    });
  }
  renderTable(rows);
}


function showResults(data) {
  window.lastResults = data;
  const view = document.getElementById('view');
  if (graphTypeSel.value === 'timeseries') {
    showTimeSeries(data);
  } else {
    if (data.rows.length === 0) {
      view.innerHTML =
        '<p id="empty-message">Empty data provided to table</p><table id="results"></table>';
    } else {
      view.innerHTML = '<table id="results"></table>';
    }
    originalRows = data.rows.slice();
    sortState = {index: null, dir: null};
    renderTable(originalRows);
  }
  const sqlEl = document.createElement('pre');
  sqlEl.id = 'sql_query';
  sqlEl.style.whiteSpace = 'pre-wrap';
  sqlEl.style.marginTop = '10px';
  sqlEl.textContent = data.sql;
  view.appendChild(sqlEl);
  document.getElementById('query_info').textContent =
    `Your query took about ${lastQueryTime} ms`;
}

function showError(err) {
  window.lastResults = err;
  const view = document.getElementById('view');
  let msg = '';
  if (typeof err === 'string') {
    msg = err;
  } else if (err) {
    msg = err.error || 'Error';
    if (err.sql) {
      msg += '\nSQL: ' + err.sql;
    }
    if (err.traceback) {
      msg += '\n' + err.traceback;
    }
  }
  view.innerHTML = `<pre id="error-message">${msg}</pre>`;
  document.getElementById('query_info').textContent = '';
}

function setSelectValue(selector, value) {
  const el = typeof selector === 'string' ? document.querySelector(selector) : selector;
  if (el) {
    const select = el.tagName === 'SELECT' ? el : el.querySelector('select');
    if (select) {
      select.value = value;
      select.dispatchEvent(new Event('change'));
    }
  }
}
</script>
</body>
</html>
