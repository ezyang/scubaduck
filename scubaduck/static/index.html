<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ScubaDuck</title>
  <style>
    body { display: flex; font-family: sans-serif; margin: 0; }
    #sidebar { width: 300px; padding: 10px; border-right: 1px solid #ccc; }
    #view { flex: 1; padding: 10px; }
    .field { margin-bottom: 10px; }
    th { text-align: left; cursor: pointer; }
    th.sorted { color: blue; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Query</h3>
    <div class="field">
      <label>Start <input id="start" type="text" /></label>
    </div>
    <div class="field">
      <label>End <input id="end" type="text" /></label>
    </div>
    <div class="field">
      <label>Order By <select id="order_by"></select>
        <select id="order_dir">
          <option value="ASC">ASC</option>
          <option value="DESC">DESC</option>
        </select>
      </label>
    </div>
    <div class="field">
      <label>Limit <input id="limit" type="number" value="100" /></label>
    </div>
    <div id="filters" class="field">
      <button type="button" onclick="addFilter()">Add Filter</button>
    </div>
    <button onclick="dive()">Dive</button>
  </div>
  <div id="view">
    <table id="results"></table>
  </div>
<script>
const columns = [];
fetch('/api/columns').then(r => r.json()).then(cols => {
  const orderSelect = document.getElementById('order_by');
  cols.forEach(c => {
    const o = document.createElement('option');
    o.value = c.name;
    o.textContent = c.name;
    orderSelect.appendChild(o);
    columns.push(c.name);
  });
});

let originalRows = [];
let sortState = {index: null, dir: 0}; // dir: 0 none, 1 desc, 2 asc

function addFilter() {
  const container = document.createElement('div');
  container.className = 'filter';
  container.innerHTML = `
    <select class="f-col"></select>
    <select class="f-op">
      <option value="=">=</option>
      <option value="!=">!=</option>
      <option value="<"><</option>
      <option value=">">></option>
    </select>
    <input class="f-val" type="text">
    <button type="button" onclick="this.parentElement.remove()">X</button>
  `;
  container.querySelector('.f-col').innerHTML = columns.map(c => `<option value="${c}">${c}</option>`).join('');
  document.getElementById('filters').appendChild(container);
}

function dive() {
  const payload = {
    start: document.getElementById('start').value,
    end: document.getElementById('end').value,
    order_by: document.getElementById('order_by').value,
    order_dir: document.getElementById('order_dir').value,
    limit: parseInt(document.getElementById('limit').value, 10),
    columns
  };
  payload.filters = Array.from(document.querySelectorAll('#filters .filter')).map(f => {
    const raw = f.querySelector('.f-val').value.trim();
    if (raw === '') {
      return {column: f.querySelector('.f-col').value, op: f.querySelector('.f-op').value, value: null};
    }
    const parts = raw.split(/\s+/);
    const value = parts.length > 1 ? parts : parts[0];
    return {column: f.querySelector('.f-col').value, op: f.querySelector('.f-op').value, value};
  });
  fetch('/api/query', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
    .then(r=>r.json())
    .then(showResults);
}

function showResults(data) {
  window.lastResults = data;
  originalRows = data.rows.slice();
  sortState = {index: null, dir: 0};
  renderTable();
}

function renderTable() {
  const table = document.getElementById('results');
  table.innerHTML = '';
  if (originalRows.length === 0) return;
  const header = document.createElement('tr');
  originalRows[0].forEach((_, i) => {
    const th = document.createElement('th');
    th.textContent = columns[i];
    th.onclick = () => {
      if (sortState.index !== i) {
        sortState.index = i;
        sortState.dir = 1; // descending first
      } else {
        sortState.dir = (sortState.dir + 1) % 3;
        if (sortState.dir === 0) sortState.index = null;
      }
      renderTable();
    };
    if (sortState.index === i && sortState.dir !== 0) {
      th.classList.add('sorted');
      th.textContent += sortState.dir === 1 ? ' \u2193' : ' \u2191';
    }
    header.appendChild(th);
  });
  table.appendChild(header);
  let rows = originalRows.slice();
  if (sortState.dir !== 0 && sortState.index !== null) {
    const idx = sortState.index;
    rows.sort((a, b) => {
      let av = a[idx];
      let bv = b[idx];
      const na = parseFloat(av);
      const nb = parseFloat(bv);
      if (!isNaN(na) && !isNaN(nb)) { av = na; bv = nb; }
      if (av === bv) return 0;
      return (av < bv ? -1 : 1) * (sortState.dir === 1 ? -1 : 1);
    });
  }
  rows.forEach(row => {
    const tr = document.createElement('tr');
    row.forEach(v => {
      const td = document.createElement('td'); td.textContent = v; tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}
</script>
</body>
</html>
