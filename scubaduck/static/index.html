<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ScubaDuck</title>
  <style>
    body { margin: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
    #header { padding: 10px; font-weight: bold; border-bottom: 1px solid #ccc; }
    #content { flex: 1; display: flex; height: calc(100vh - 42px); overflow: hidden; }
    #sidebar { width: 300px; padding: 10px; border-right: 1px solid #ccc; overflow-y: auto; display: flex; flex-direction: column; }
    #view { flex: 1; padding: 10px; overflow-y: auto; overflow-x: auto; }
    .field { display: flex; align-items: center; margin-bottom: 10px; }
    .field label { width: 80px; text-align: right; margin-right: 5px; }
    .help { margin-left: 4px; cursor: help; }
    .rel-btn { margin-left: 4px; }
    .rel-select { margin-left: 4px; }
    #tabs { display: flex; align-items: center; margin-bottom: 10px; }
    #tabs .tab { margin-right: 5px; background: none; border: 1px solid #ccc; padding: 4px 8px; cursor: pointer; width: 120px; text-align: center; box-sizing: border-box; }
    #tabs .tab.active { background: #eee; font-weight: bold; }
    #dive { margin-left: auto; background: green; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #filter_list { display: flex; flex-direction: column; }
    #filters .filter {
      border: 1px solid #ccc;
      padding: 5px;
      margin-bottom: 5px;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    #filters .filter-row { display: flex; margin-bottom: 5px; }
    #filters .filter-row .f-col { flex: 1; }
    #filters .filter-row .f-op { width: 60px; margin-left: 5px; }
    #filters .filter input.f-val {
      border: none;
      flex: 1;
      min-width: 60px;
      margin: 2px;
      outline: none;
    }
    #filters .filter .chip-box { position: relative; }
    #filters .chip-input { display: flex; flex-wrap: wrap; border: 1px solid #ccc; padding: 2px; min-height: 24px; }
    #filters .chip { background: #eee; border: 1px solid #999; padding: 2px 4px; margin: 2px; border-radius: 3px; display: flex; align-items: center; }
    #filters .chip .x { margin-left: 4px; cursor: pointer; }
    #filters .chip-copy { margin-left: 4px; cursor: pointer; background: none; border: none; }
    #filters .chip-dropdown { position: absolute; left: 0; right: 0; top: 100%; background: white; border: 1px solid #ccc; max-height: 120px; overflow-y: auto; z-index: 10; display: none; }
    #filters .chip-dropdown div { padding: 2px 4px; cursor: pointer; }
    #filters .chip-dropdown div.highlight { background: #bde4ff; }
    #filters .filter button.remove { position: absolute; top: 2px; right: 2px; }
    #filters h4 { margin: 0 0 5px 0; }
    table { border-collapse: collapse; min-width: 100%; }
    th, td { border: 1px solid #ccc; padding: 4px; box-sizing: border-box; }
    th { text-align: left; cursor: pointer; position: relative; }
    th.sorted { color: blue; }
    tr:nth-child(even) td { background: #f9f9f9; }
    tr.selected td { background: #bde4ff !important; }
    tr:hover:not(.selected) td { background: #eee; }
    .col-resizer {
      position: absolute;
      top: 0;
      right: 0;
      width: 5px;
      height: 100%;
      cursor: col-resize;
    }
  </style>
</head>
<body>
  <div id="header">sample.csv - events</div>
  <div id="content">
    <div id="sidebar">
      <div id="tabs">
        <button class="tab active" data-tab="settings">View Settings</button>
        <button class="tab" data-tab="columns">Columns</button>
        <button id="dive" onclick="dive()">Dive</button>
      </div>
      <div id="settings" class="tab-content active">
        <div class="field">
          <label>Start<span class="help" title="Sets the start/end of the time range to query. Can be any kind of datetime string. For example: 'April 23, 2014' or 'yesterday'.">[?]</span></label>
          <input id="start" type="text" />
          <button type="button" class="rel-btn" data-target="start-select">&#9660;</button>
          <select id="start-select" class="rel-select" data-input="start" style="display:none">
            <option value="-1 hour">-1 hour</option>
            <option value="-3 hours">-3 hours</option>
            <option value="-12 hours">-12 hours</option>
            <option value="-1 day">-1 day</option>
            <option value="-3 days">-3 days</option>
            <option value="-1 week">-1 week</option>
            <option value="-1 fortnight">-1 fortnight</option>
            <option value="-30 days">-30 days</option>
            <option value="-90 days">-90 days</option>
          </select>
        </div>
        <div class="field">
          <label>End<span class="help" title="Sets the start/end of the time range to query. Can be any kind of datetime string. For example: 'April 23, 2014' or 'yesterday'.">[?]</span></label>
          <input id="end" type="text" />
          <button type="button" class="rel-btn" data-target="end-select">&#9660;</button>
          <select id="end-select" class="rel-select" data-input="end" style="display:none">
            <option value="-1 hour">-1 hour</option>
            <option value="-3 hours">-3 hours</option>
            <option value="-12 hours">-12 hours</option>
            <option value="-1 day">-1 day</option>
            <option value="-3 days">-3 days</option>
            <option value="-1 week">-1 week</option>
            <option value="-1 fortnight">-1 fortnight</option>
            <option value="-30 days">-30 days</option>
            <option value="-90 days">-90 days</option>
          </select>
        </div>
        <div class="field">
          <label>Order By<span class="help" title="Choose a column to sort results by.">[?]</span></label>
          <select id="order_by"></select>
          <button id="order_dir" type="button">ASC \u25B2</button>
        </div>
        <div class="field">
          <label>Limit<span class="help" title="Choose the maximum number of results to show in the chart after any aggregations have been applied. For example, a limit of 10 will show no more than 10 rows for a table, etc.">[?]</span></label>
          <input id="limit" type="number" value="100" />
        </div>
        <div id="filters">
          <h4>Filters<span class="help" title="You can create as many filters as you want. You can either write a filter using a UI or manual SQL. In the UI, filter consists of a column name, a relation (e.g., =, !=, <, >) and then a text field. The text field is a token input. It accepts multiple tokens for = relation, in which case we match using an OR for all options.">[?]</span></h4>
          <div id="filter_list"></div>
          <button id="add_filter" type="button" onclick="addFilter()">Add Filter</button>
        </div>
        <div id="query_info" style="margin-top:10px;"></div>
      </div>
      <div id="columns" class="tab-content">
        <button id="columns_all" type="button">All</button>
        <button id="columns_none" type="button">None</button>
        <div id="column_groups"></div>
      </div>
    </div>
    <div id="view">
      <table id="results"></table>
    </div>
  </div>
<script>
const allColumns = [];
const columnTypes = {};
const stringColumns = [];
const integerColumns = [];
const timeColumns = [];
let selectedColumns = [];
let orderDir = 'ASC';
const orderDirBtn = document.getElementById('order_dir');
function updateOrderDirButton() {
  orderDirBtn.textContent = orderDir + (orderDir === 'ASC' ? ' \u25B2' : ' \u25BC');
}
orderDirBtn.addEventListener('click', () => {
  orderDir = orderDir === 'ASC' ? 'DESC' : 'ASC';
  updateOrderDirButton();
});
updateOrderDirButton();
fetch('/api/columns').then(r => r.json()).then(cols => {
  const orderSelect = document.getElementById('order_by');
  const groupsEl = document.getElementById('column_groups');
  const groups = {
    time: {name: 'Time', cols: [], ul: null},
    integer: {name: 'Integers', cols: [], ul: null},
    string: {name: 'Strings', cols: [], ul: null}
  };
  cols.forEach(c => {
    const t = c.type.toUpperCase();
    columnTypes[c.name] = c.type;
    allColumns.push(c.name);
    let g = 'string';
    if (t.includes('INT')) g = 'integer';
    if (t.includes('TIMESTAMP')) g = 'time';
    groups[g].cols.push(c.name);
    if (g !== 'string') {
      const o = document.createElement('option');
      o.value = c.name;
      o.textContent = c.name;
      orderSelect.appendChild(o);
    }
  });
  Object.keys(groups).forEach(key => {
    const g = groups[key];
    const div = document.createElement('div');
    div.className = 'col-group';
    const header = document.createElement('div');
    header.textContent = g.name + ': ';
    const allBtn = document.createElement('button');
    allBtn.type = 'button';
    allBtn.textContent = 'All';
    const noneBtn = document.createElement('button');
    noneBtn.type = 'button';
    noneBtn.textContent = 'None';
    header.appendChild(allBtn);
    header.appendChild(noneBtn);
    div.appendChild(header);
    const ul = document.createElement('ul');
    g.ul = ul;
    g.cols.forEach(name => {
      const li = document.createElement('li');
      const label = document.createElement('label');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = name;
      cb.checked = true;
      cb.addEventListener('change', updateSelectedColumns);
      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + name));
      li.appendChild(label);
      ul.appendChild(li);
    });
    allBtn.addEventListener('click', () => {
      ul.querySelectorAll('input').forEach(cb => (cb.checked = true));
      updateSelectedColumns();
    });
    noneBtn.addEventListener('click', () => {
      ul.querySelectorAll('input').forEach(cb => (cb.checked = false));
      updateSelectedColumns();
    });
    div.appendChild(ul);
    groupsEl.appendChild(div);
  });
  document.getElementById('columns_all').addEventListener('click', () => {
    groupsEl.querySelectorAll('input').forEach(cb => (cb.checked = true));
    updateSelectedColumns();
  });
  document.getElementById('columns_none').addEventListener('click', () => {
    groupsEl.querySelectorAll('input').forEach(cb => (cb.checked = false));
    updateSelectedColumns();
  });
  updateSelectedColumns();
  addFilter();
});

document.querySelectorAll('#tabs .tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#tabs .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

document.querySelectorAll('.rel-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const sel = document.getElementById(btn.dataset.target);
    sel.style.display = sel.style.display === 'none' ? 'block' : 'none';
  });
});
document.querySelectorAll('.rel-select').forEach(sel => {
  sel.addEventListener('change', () => {
    const input = document.getElementById(sel.dataset.input);
    input.value = sel.value;
    sel.style.display = 'none';
  });
});

function updateSelectedColumns() {
  selectedColumns = allColumns.filter(name => {
    const cb = document.querySelector(
      `#column_groups input[value="${name}"]`
    );
    return cb && cb.checked;
  });
}

function isStringColumn(name) {
  const t = (columnTypes[name] || '').toUpperCase();
  return t.includes('CHAR') || t.includes('STRING') || t.includes('VARCHAR');
}

function isIntegerColumn(name) {
  const t = (columnTypes[name] || '').toUpperCase();
  return t.includes('INT');
}

function isTimeColumn(name) {
  const t = (columnTypes[name] || '').toUpperCase();
  return t.includes('TIMESTAMP');
}

function initChipInput(filter) {
  const input = filter.querySelector('.f-val');
  const chipsEl = filter.querySelector('.chip-input');
  const dropdown = filter.querySelector('.chip-dropdown');
  const copyBtn = filter.querySelector('.chip-copy');
  const chips = [];
  filter.chips = chips;
  let options = [];
  let highlight = 0;

  chipsEl.addEventListener('click', () => {
    input.focus();
  });

    function renderChips() {
      chipsEl.querySelectorAll('.chip').forEach(c => c.remove());
      chips.forEach((v, i) => {
        const span = document.createElement('span');
        span.className = 'chip';
        span.textContent = v;
        const x = document.createElement('span');
        x.className = 'x';
        x.textContent = 'x';
        x.addEventListener('click', () => {
          chips.splice(i, 1);
          renderChips();
        });
        span.appendChild(x);
        chipsEl.insertBefore(span, input);
      });
    }

  function hideDropdown() {
    dropdown.style.display = 'none';
  }

  function showDropdown() {
    dropdown.style.display = 'block';
  }

  function updateHighlight() {
    Array.from(dropdown.children).forEach((c, i) => {
      c.classList.toggle('highlight', i === highlight);
    });
  }

  function addChip(val) {
    if (!val) return;
    chips.push(val);
    input.value = '';
    renderChips();
  }

  copyBtn.addEventListener('click', () => {
    navigator.clipboard && navigator.clipboard.writeText(chips.join(','));
  });

  input.addEventListener('paste', e => {
    e.preventDefault();
    const text = e.clipboardData.getData('text');
    if (e.shiftKey) {
      addChip(text.trim());
    } else {
      text.split(',').forEach(t => addChip(t.trim()));
    }
    hideDropdown();
  });

  input.addEventListener('keydown', e => {
    if (e.key === 'ArrowDown') {
      if (dropdown.style.display !== 'none') {
        highlight = Math.min(highlight + 1, dropdown.children.length - 1);
        updateHighlight();
      }
      e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      if (dropdown.style.display !== 'none') {
        highlight = Math.max(highlight - 1, 0);
        updateHighlight();
      }
      e.preventDefault();
    } else if (e.key === 'Backspace' && input.value === '') {
      if (chips.length > 0) {
        chips.pop();
        renderChips();
      }
      hideDropdown();
    } else if (e.key === 'Enter') {
      if (dropdown.style.display !== 'none' && dropdown.children.length > 0) {
        const val = dropdown.children[highlight].dataset.value;
        if (val !== input.value.trim()) {
          addChip(val);
        } else {
          addChip(input.value.trim());
        }
      } else {
        addChip(input.value.trim());
      }
      hideDropdown();
      e.preventDefault();
    }
  });

  function renderDropdown(vals) {
    dropdown.innerHTML = '';
    const typed = input.value.trim();
    if (typed) {
      vals.splice(1, 0, typed);
    }
    vals.forEach((v, i) => {
      const d = document.createElement('div');
      d.textContent = v;
      d.dataset.value = v;
      d.addEventListener('mouseover', () => {
        highlight = i;
        updateHighlight();
      });
      d.addEventListener('mousedown', evt => {
        evt.preventDefault();
        addChip(v);
        hideDropdown();
      });
      dropdown.appendChild(d);
    });
    if (vals.length) {
      highlight = 0;
      updateHighlight();
      showDropdown();
    } else {
      hideDropdown();
    }
  }

  function loadOptions() {
    const col = filter.querySelector('.f-col').value;
    if (!isStringColumn(col)) {
      dropdown.innerHTML = '';
      return;
    }
    fetch(`/api/samples?column=${encodeURIComponent(col)}&q=${encodeURIComponent(input.value)}`)
      .then(r => r.json())
      .then(data => {
        options = data;
        renderDropdown(options.slice());
      });
  }

  input.addEventListener('focus', loadOptions);
  input.addEventListener('input', loadOptions);

  document.addEventListener('click', evt => {
    if (!filter.contains(evt.target)) {
      hideDropdown();
    }
  });
}

function addFilter() {
  const container = document.createElement('div');
  container.className = 'filter';
  container.innerHTML = `
    <div class="filter-row">
      <select class="f-col"></select>
      <select class="f-op">
      </select>
    </div>
    <div class="chip-box">
      <div class="chip-input">
        <input class="f-val" type="text">
        <button type="button" class="chip-copy">\u2398</button>
      </div>
      <div class="chip-dropdown"></div>
    </div>
    <button type="button" class="remove" onclick="this.parentElement.remove()">X</button>
  `;
  const colSel = container.querySelector('.f-col');
  colSel.innerHTML = allColumns.map(c => `<option value="${c}">${c}</option>`).join('');

  function populateOps() {
    const opSel = container.querySelector('.f-op');
    const col = colSel.value;
    const ops = isStringColumn(col)
      ? [
          ['=', '='],
          ['!=', '!='],
          ['~', 'matches regex'],
          ['!~', 'not matches regex'],
          ['contains', 'contains'],
          ['!contains', 'not contains'],
          ['empty', 'empty'],
          ['!empty', 'not empty'],
          ['LIKE', 'like'],
        ]
      : [
          ['=', '='],
          ['!=', '!='],
          ['<', '<'],
          ['>', '>'],
        ];
    opSel.innerHTML = ops.map(o => `<option value="${o[0]}">${o[1]}</option>`).join('');
    updateInputVis();
  }

  function updateInputVis() {
    const op = container.querySelector('.f-op').value;
    const box = container.querySelector('.chip-box');
    box.style.display = op === 'empty' || op === '!empty' ? 'none' : 'block';
  }

  colSel.addEventListener('change', populateOps);
  container.querySelector('.f-op').addEventListener('change', updateInputVis);
  populateOps();
  document.getElementById('filter_list').appendChild(container);
  initChipInput(container);
}

let lastQueryTime = 0;
let queryStart = 0;

function dive() {
  updateSelectedColumns();
  const payload = {
    start: document.getElementById('start').value,
    end: document.getElementById('end').value,
    order_by: document.getElementById('order_by').value,
    order_dir: orderDir,
    limit: parseInt(document.getElementById('limit').value, 10),
    columns: selectedColumns
  };
  payload.filters = Array.from(document.querySelectorAll('#filters .filter')).map(f => {
    const chips = f.chips || [];
    const op = f.querySelector('.f-op').value;
    let value = null;
    if (op !== 'empty' && op !== '!empty') {
      value = chips.length === 0 ? null : (chips.length === 1 ? chips[0] : chips);
    }
    return {column: f.querySelector('.f-col').value, op, value};
  });
  const view = document.getElementById('view');
  view.innerHTML = '<p>Loading...</p>';
  queryStart = performance.now();
  fetch('/api/query', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
    .then(r=>r.json())
    .then(data => {
      lastQueryTime = Math.round(performance.now() - queryStart);
      showResults(data);
    });
}

let originalRows = [];
let sortState = {index: null, dir: null};
let colWidths = [];
let resizeInfo = null;

function applyColumnWidths() {
  const table = document.getElementById('results');
  const view = document.getElementById('view');
  const ths = table.querySelectorAll('th');
  const rows = table.querySelectorAll('tr');
  ths.forEach((th, i) => {
    th.style.width = colWidths[i] + 'px';
  });
  rows.forEach(tr => {
    tr.querySelectorAll('td').forEach((td, i) => {
      td.style.width = colWidths[i] + 'px';
    });
  });
  const total = colWidths.reduce((a, b) => a + b, 0);
  table.style.width = Math.max(view.clientWidth, total) + 'px';
}

function startResize(e, idx) {
  e.preventDefault();
  resizeInfo = {idx, startX: e.clientX, startWidth: colWidths[idx]};
  document.addEventListener('mousemove', onResize);
  document.addEventListener('mouseup', stopResize);
}

function onResize(e) {
  if (!resizeInfo) return;
  const diff = e.clientX - resizeInfo.startX;
  colWidths[resizeInfo.idx] = Math.max(30, resizeInfo.startWidth + diff);
  applyColumnWidths();
}

function stopResize() {
  document.removeEventListener('mousemove', onResize);
  document.removeEventListener('mouseup', stopResize);
  resizeInfo = null;
}

function renderTable(rows) {
  const table = document.getElementById('results');
  table.innerHTML = '';
  if (rows.length === 0) return;
  if (colWidths.length !== selectedColumns.length) {
    colWidths = selectedColumns.map(() => 150);
  }
  const header = document.createElement('tr');
  selectedColumns.forEach((col, i) => {
    const th = document.createElement('th');
    th.textContent = col;
    th.dataset.index = i;
    th.addEventListener('click', handleSort);
    if (sortState.index === i) {
      th.classList.add('sorted');
      th.textContent = col + (sortState.dir === 'desc' ? ' \u25BC' : ' \u25B2');
    }
    if (!isStringColumn(col)) th.style.textAlign = 'right';
    th.style.width = colWidths[i] + 'px';
    if (i < selectedColumns.length - 1) {
      const resizer = document.createElement('div');
      resizer.className = 'col-resizer';
      resizer.addEventListener('mousedown', e => startResize(e, i));
      th.appendChild(resizer);
    }
    header.appendChild(th);
  });
  table.appendChild(header);
  rows.forEach(row => {
    const tr = document.createElement('tr');
    tr.addEventListener('click', () => {
      tr.classList.toggle('selected');
    });
    row.forEach((v, i) => {
      const col = selectedColumns[i];
      const td = document.createElement('td');
      if (isTimeColumn(col)) {
        const d = new Date(v.replace(' ', 'T'));
        td.textContent = d.toLocaleString('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
          second: 'numeric',
          hour12: true,
          timeZoneName: 'short'
        });
      } else {
        td.textContent = v;
      }
      td.style.textAlign = isStringColumn(col) ? 'left' : 'right';
      td.style.width = colWidths[i] + 'px';
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
  applyColumnWidths();
}

function handleSort(e) {
  const idx = parseInt(e.target.dataset.index, 10);
  if (sortState.index !== idx) {
    sortState.index = idx;
    sortState.dir = 'asc';
  } else if (sortState.dir === 'asc') {
    sortState.dir = 'desc';
  } else if (sortState.dir === 'desc') {
    sortState.index = null;
    sortState.dir = null;
  } else {
    sortState.dir = 'asc';
  }
  let rows = originalRows.slice();
  if (sortState.index !== null) {
    rows.sort((a, b) => {
      const va = a[sortState.index];
      const vb = b[sortState.index];
      if (va === vb) return 0;
      if (sortState.dir === 'desc') return va < vb ? 1 : -1;
      return va > vb ? 1 : -1;
    });
  }
  renderTable(rows);
}

function showResults(data) {
  window.lastResults = data;
  const view = document.getElementById('view');
  view.innerHTML = '<table id="results"></table>';
  originalRows = data.rows.slice();
  sortState = {index: null, dir: null};
  renderTable(originalRows);
  document.getElementById('query_info').textContent =
    `Your query took about ${lastQueryTime} ms`;
}
</script>
</body>
</html>
